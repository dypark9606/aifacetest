<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Jua&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style_Sec5.css">
    <title>커플 궁합 (매칭도) 분석</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>
    <section class="section">
        <h1 class="title text-center">커플 궁합 (매칭도) 분석</h1>
        <h2 class="subtitle text-center">우리 커플 과연 잘 어울릴까?</h2>
    </section>

    <div class="container flex-row">
        <!-- 남자 업로드 섹션 -->
        <div class="file-upload" onclick="triggerUpload('male')">
            <h3 class="text-center">남자 사진 업로드</h3>
            <div class="image-upload-wrap" id="male-upload-wrap" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event, 'male')">
                <input class="file-upload-input" id="male-upload" type="file" onchange="readURL(this, 'male');" accept="image/*" capture="camera" style="display: none;">
                <div class="drag-text">
                    <h3>남성 얼굴 사진을 클릭해서 촬영하거나 업로드하세요!</h3>
                </div>
            </div>
            <div class="file-upload-content" id="male-file-content" style="display: none;">
                <img class="file-upload-image" id="male-face-image" src="#" alt="남자 얼굴">
                <div id="male-loading" class="animated bounce" style="display: none;">
                    <p>AI가 분석 중입니다...</p>
                </div>
                <p id="male-result-message" class="result-message"></p>
            </div>
        </div>

        <!-- 여자 업로드 섹션 -->
        <div class="file-upload" onclick="triggerUpload('female')">
            <h3 class="text-center">여자 사진 업로드</h3>
            <div class="image-upload-wrap" id="female-upload-wrap" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event, 'female')">
                <input class="file-upload-input" id="female-upload" type="file" onchange="readURL(this, 'female');" accept="image/*" capture="camera" style="display: none;">
                <div class="drag-text">
                    <h3>여성 얼굴 사진을 클릭해서 촬영하거나 업로드하세요!</h3>
                </div>
            </div>
            <div class="file-upload-content" id="female-file-content" style="display: none;">
                <img class="file-upload-image" id="female-face-image" src="#" alt="여자 얼굴">
                <div id="female-loading" class="animated bounce" style="display: none;">
                    <p>AI가 분석 중입니다...</p>
                </div>
                <p id="female-result-message" class="result-message"></p>
            </div>
        </div>
    </div>

    <!-- Compatibility Result Box -->
    <div id="compatibility-result" class="compatibility-result-box" style="display: none; text-align: center; margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
        <!-- 결과가 이곳에 표시됩니다. -->
    </div>

    <footer class="footer pt-5 container d-flex justify-content-center">
        <div>
            <p>&copy; Industrial AI 2020. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        let maleScore = 0;
        let femaleScore = 0;
        let isMaleUploaded = false;
        let isFemaleUploaded = false;

        function triggerUpload(gender) {
            document.getElementById(gender + "-upload").click();
        }

        function readURL(input, gender) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgElement = document.getElementById(`${gender}-face-image`);
                    imgElement.src = e.target.result;
                    imgElement.style.display = "block";
                    document.getElementById(`${gender}-upload-wrap`).style.display = "none";
                    document.getElementById(`${gender}-file-content`).style.display = "block";
                    
                    if (gender === 'male') {
                        isMaleUploaded = true;
                    } else if (gender === 'female') {
                        isFemaleUploaded = true;
                    }

                    setTimeout(() => {
                        predict(gender);
                    }, 2000);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function predict(gender) {
            const img = document.getElementById(`${gender}-face-image`);
            const model = gender === "male" ? maleModel : femaleModel;
            
            if (!model) return;
            
            const predictions = await model.predict(img, false);
            const topPrediction = predictions.sort((a, b) => b.probability - a.probability)[0];
            const score = Math.round(topPrediction.probability * 100);

            if (gender === 'male') {
                maleScore = score;
                document.getElementById("male-result-message").innerText = `남성 점수: ${maleScore}`;
            } else if (gender === 'female') {
                femaleScore = score;
                document.getElementById("female-result-message").innerText = `여성 점수: ${femaleScore}`;
            }

            if (isMaleUploaded && isFemaleUploaded) {
                calculateCompatibility();
            }
        }

        function calculateCompatibility() {
            const totalScore = maleScore + femaleScore;
            let message;

            if (totalScore >= 180) {
                message = "아주 잘 어울리는 커플이네요! 서로의 장단점을 잘 이해하고 조화롭게 보완하는 이상적인 관계입니다. 주위 사람들에게도 아름다운 커플로 보일 거예요.";
            } else if (totalScore >= 160) {
                message = "잘 어울리는 커플이에요! 서로의 성향을 잘 파악하고 상대방을 이해하려는 노력이 엿보입니다. 꾸준한 대화와 소통으로 더 가까워질 수 있어요.";
            } else if (totalScore >= 140) {
                message = "서로 좋은 점을 많이 발견하는 커플이네요. 관계를 유지하는 데 큰 무리는 없지만, 가끔씩 작은 오해가 생길 수 있습니다.";
            } else if (totalScore >= 120) {
                message = "궁합이 꽤 잘 맞는 편이에요. 서로를 이해하고 배려하려는 마음이 있지만, 때로는 작은 충돌이 있을 수 있습니다.";
            } else if (totalScore >= 100) {
                message = "보통의 궁합을 가진 커플이에요. 서로 다른 배경과 가치관을 존중하며, 차이를 극복하려는 노력이 필요합니다.";
            } else if (totalScore >= 80) {
                message = "서로 노력해야 좋은 커플이 될 수 있는 관계입니다. 서로를 이해하고자 하는 마음은 있지만, 생각의 차이가 다소 큰 편이에요.";
            } else if (totalScore >= 60) {
                message = "노력에 따라 좋은 관계로 발전할 가능성이 있어요. 서로에 대한 이해가 다소 부족할 수 있지만, 이를 극복하려는 노력이 필요합니다.";
            } else if (totalScore >= 40) {
                message = "서로의 성향이 상당히 다르지만, 노력하면 나아질 가능성은 있어요. 때로는 갈등이 잦을 수 있지만, 상대방의 입장을 이해하려는 노력이 필요합니다.";
            } else {
                message = "정말 잘 안 어울리는 커플이네요. 서로의 성향과 가치관 차이가 커서 자주 부딪힐 가능성이 높습니다. 각자의 차이를 인정하고 수용하는 것이 중요합니다.";
            }

            document.getElementById("compatibility-result").innerHTML = `<h3>커플 궁합 점수: ${totalScore}</h3><p>${message}</p>`;
            document.getElementById("compatibility-result").style.display = "block";
        }

        // 모델 초기화
        const urlMale = "./AI_model/AI_handsome_m_ver2/";
        const urlFemale = "./AI_model/AI_handsome_w_ver2/";
        let maleModel, femaleModel;

        async function initModels() {
            maleModel = await tmImage.load(urlMale + "model.json", urlMale + "metadata.json");
            femaleModel = await tmImage.load(urlFemale + "model.json", urlFemale + "metadata.json");
        }
        window.onload = initModels;
    </script>
</body>
</html>
